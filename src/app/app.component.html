<div class="sdc-container">
  <!-- Componente Sidebar Modular -->
  <app-sidebar></app-sidebar>

  <main class="main-stage">
    <header class="stage-header" [class.connected-anim]="wsStatus === 'Conectado'">
      <div class="header-left-group">
        <button class="icon-btn toggle-btn" (click)="toggleLeftSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <!-- Refresh Button (Only active for active iframes) -->
        <button class="icon-btn toggle-btn" 
                *ngIf="(activeTabId$ | async) !== 'dashboard' && (activeTabId$ | async) !== 'connections' && (activeTabId$ | async) !== 'monitor' && (activeTabId$ | async) !== 'security'" 
                (click)="reloadActiveIframe()" 
                title="Actualizar Aplicación">
           <i class="fas fa-redo-alt"></i>
        </button>

        <nav class="compass-tab-bar" *ngIf="(openTabs$ | async) as tabs">
          <div class="compass-tab" [class.active]="(activeTabId$ | async) === 'dashboard'" (click)="switchToDashboard()">
            <i class="fas fa-th-large"></i> <span *ngIf="tabs.length <= 3 || (activeTabId$ | async) === 'dashboard'" class="tab-label fade-in">Dashboard</span>
          </div>

          <div class="compass-tab" *ngFor="let tab of tabs" [class.active]="(activeTabId$ | async) === tab.id"
            (click)="selectTab(tab.id)">
            <i [class]="tab.icon"></i>
            <span *ngIf="tabs.length <= 2 || (activeTabId$ | async) === tab.id" class="tab-label fade-in">{{ tab.name }}</span>
            <span class="tab-close-hitbox" (click)="closeTab(tab.id, $event)">
               <i class="fas fa-times"></i>
            </span>
          </div>
        </nav>
      </div>

      <div class="header-right-group">
        <div class="connection-pill" [style.border-color]="statusColor">
          <div class="pulse-dot" [style.background-color]="statusColor"
            [class.pulse-animation]="wsStatus === 'Conectado'"></div>
          <span class="status-text">{{ wsStatus }}</span>
        </div>
        <div class="app-brand-display">Sandra <span class="brand-lite">DC</span></div>
      </div>
    </header>

    <section class="content-area" 
      [class.sidebar-left-open]="leftSidebarOpen$ | async"
      [class.inspector-open]="rightSidebarOpen$ | async">
      <!-- Página Dashboard Modular -->
      <app-dashboard 
        *ngIf="(activeTabId$ | async) === 'dashboard'"
        [stats]="stats"
        [networkInfo]="networkInfo"
        [apps]="apps"
        [dbStats]="dbStats"
        (onInstall)="DownloadAppRepo($event)"
        (onOpen)="openApp($event)"
        (onUpdate)="updateApp($event)"
        (onDelete)="deleteApp($event)"
        (onDbClick)="showDbModal = true"
        (onIpClick)="showIpInfo()"
        (onMacClick)="showMacInfo()"
      ></app-dashboard>

      <app-connections *ngIf="(activeTabId$ | async) === 'connections'"></app-connections>
      <app-security *ngIf="(activeTabId$ | async) === 'security'"></app-security>
      <app-monitor *ngIf="(activeTabId$ | async) === 'monitor'"></app-monitor>

      <!-- Iframe Container para Apps -->
      <div class="app-iframe-wrapper" *ngFor="let tab of (openTabs$ | async)" [hidden]="(activeTabId$ | async) !== tab.id">
        <iframe [id]="'iframe-' + tab.id" [src]="tab.url" frameborder="0" (load)="onIframeLoad(tab.id)"></iframe>
      </div>
    </section>
  </main>

  <app-inspector *ngIf="(activeTabId$ | async) !== 'dashboard' && (activeTabId$ | async) !== 'connections' && (activeTabId$ | async) !== 'monitor' && (activeTabId$ | async) !== 'security'"></app-inspector>

  <div class="modal-overlay" *ngIf="installModal.show">
    <div class="modal-card">
      <h3 class="modal-title">{{ installModal.title }}</h3>
      <div class="modal-body">
        <p class="modal-message" [class.error-text]="installModal.error">{{ installModal.error || installModal.message
          }}</p>
        <div class="progress-track" *ngIf="!installModal.error && !installModal.success">
          <div class="progress-bar-indeterminate"></div>
        </div>
        <div class="modal-actions">
          <button class="btn-modal-cancel" *ngIf="installModal.error || installModal.success" (click)="closeModal()">
            {{ installModal.error ? 'Cerrar' : 'Entendido' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="confirmModal.show">
    <div class="modal-card">
      <h3 class="modal-title">{{ confirmModal.title }}</h3>
      <div class="modal-body">
        <p class="modal-message">{{ confirmModal.message }}</p>
        <div class="modal-actions">
          <button class="btn-modal-cancel" (click)="cancelDelete()">Cancelar</button>
          <button class="btn-modal-confirm" (click)="confirmDelete()">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showSaveLogModal">
    <div class="modal-card">
      <h3 class="modal-title">Monitor de Actividad</h3>
      <div class="modal-body">
        <p class="modal-message">Hemos detectado tráfico de red en esta sesión. <br>¿Deseas guardar el registro antes de cerrar?</p>
        <div class="modal-actions">
          <button class="btn-modal-cancel" (click)="confirmCloseTab(false)">No guardar</button>
          <button class="btn-modal-save" (click)="confirmCloseTab(true)">Guardar Log</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modular Storage Component -->
  <app-storage *ngIf="showDbModal" (close)="showDbModal = false"></app-storage>



  <!-- Modal de Configuración Avanzada -->
  <app-config 
    *ngIf="showControlPanel"
    [config]="config" 
    [networkInfo]="networkInfo"
    [availableConnections]="availableConnections"
    [activeConnection]="activeConnection"
    (onSave)="saveConfig()"
    (onActivateConnection)="activateConnectionGlobal($event)"
    (onDisconnect)="disconnectConnection($event)"
    (close)="showControlPanel = false">
  </app-config>
</div>