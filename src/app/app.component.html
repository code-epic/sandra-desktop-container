<div class="sdc-container">
  <!-- Componente Sidebar Modular -->
  <app-sidebar></app-sidebar>

  <main class="main-stage">
    <header class="stage-header" [class.connected-anim]="wsStatus === 'Connected'">
      <div class="header-left-group">
        <button class="icon-btn toggle-btn" (click)="toggleLeftSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <!-- Refresh Button (Only active for active iframes) -->
        <button class="icon-btn toggle-btn" 
                *ngIf="(activeTabId$ | async) !== 'dashboard' && (activeTabId$ | async) !== 'connections' && (activeTabId$ | async) !== 'monitor' && (activeTabId$ | async) !== 'security'" 
                (click)="reloadActiveIframe()" 
                title="Actualizar Aplicación">
           <i class="fas fa-redo-alt"></i>
        </button>

        <nav class="compass-tab-bar" *ngIf="(openTabs$ | async) as tabs">
          <div class="compass-tab" [class.active]="(activeTabId$ | async) === 'dashboard'" (click)="switchToDashboard()">
            <i class="fas fa-th-large"></i> <span *ngIf="tabs.length <= 3 || (activeTabId$ | async) === 'dashboard'" class="tab-label fade-in">Dashboard</span>
          </div>

          <div class="compass-tab" *ngFor="let tab of tabs" [class.active]="(activeTabId$ | async) === tab.id"
            (click)="appState.setActiveTab(tab.id)">
            <i [class]="tab.icon"></i>
            <span *ngIf="tabs.length <= 2 || (activeTabId$ | async) === tab.id" class="tab-label fade-in">{{ tab.name }}</span>
            <i class="fas fa-times close-icon" (click)="closeTab(tab.id, $event)"></i>
          </div>
        </nav>
      </div>

      <div class="header-right-group">
        <div class="connection-pill" [style.border-color]="statusColor">
          <div class="pulse-dot" [style.background-color]="statusColor"
            [class.pulse-animation]="wsStatus === 'Connected'"></div>
          <span class="status-text">{{ wsStatus }}</span>
        </div>
        <div class="app-brand-display">Sandra <span class="brand-lite">DC</span></div>
      </div>
    </header>

    <section class="content-area" 
      [class.sidebar-left-open]="leftSidebarOpen$ | async"
      [class.inspector-open]="rightSidebarOpen$ | async">
      <!-- Página Dashboard Modular -->
      <app-dashboard 
        *ngIf="(activeTabId$ | async) === 'dashboard'"
        [stats]="stats"
        [networkInfo]="networkInfo"
        [apps]="apps"
        (onInstall)="DownloadAppRepo($event)"
        (onOpen)="openApp($event)"
        (onUpdate)="updateApp($event)"
        (onDelete)="deleteApp($event)"
        (onDbClick)="showDbModal = true"
      ></app-dashboard>

      <app-connections *ngIf="(activeTabId$ | async) === 'connections'"></app-connections>
      <app-security *ngIf="(activeTabId$ | async) === 'security'"></app-security>
      <app-monitor *ngIf="(activeTabId$ | async) === 'monitor'"></app-monitor>

      <!-- Iframe Container para Apps -->
      <div class="app-iframe-wrapper" *ngFor="let tab of (openTabs$ | async)" [hidden]="(activeTabId$ | async) !== tab.id">
        <iframe [id]="'iframe-' + tab.id" [src]="tab.url" frameborder="0"></iframe>
      </div>
    </section>
  </main>

  <app-inspector></app-inspector>

  <div class="modal-overlay" *ngIf="installModal.show">
    <div class="modal-card">
      <h3 class="modal-title">{{ installModal.title }}</h3>
      <div class="modal-body">
        <p class="modal-message" [class.error-text]="installModal.error">{{ installModal.error || installModal.message
          }}</p>
        <div class="progress-track" *ngIf="!installModal.error && !installModal.success">
          <div class="progress-bar-indeterminate"></div>
        </div>
        <div class="modal-actions">
          <button class="btn-modal-cancel" *ngIf="installModal.error || installModal.success" (click)="closeModal()">
            {{ installModal.error ? 'Cerrar' : 'Entendido' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="confirmModal.show">
    <div class="modal-card">
      <h3 class="modal-title">{{ confirmModal.title }}</h3>
      <div class="modal-body">
        <p class="modal-message">{{ confirmModal.message }}</p>
        <div class="modal-actions">
          <button class="btn-modal-cancel" (click)="cancelDelete()">Cancelar</button>
          <button class="btn-modal-confirm" (click)="confirmDelete()">Eliminar</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modular Storage Component -->
  <app-storage *ngIf="showDbModal" (close)="showDbModal = false"></app-storage>



  <!-- Modal de Configuración Avanzada -->
  <div class="modal-overlay config-overlay" *ngIf="showControlPanel">
    <div class="config-card">
      <aside class="config-sidebar">
        <div class="config-header-title">Configuración</div>
        <ul class="config-nav">
          <li [class.active]="activeConfigTab === 'logs'" (click)="activeConfigTab = 'logs'">
            <i class="fas fa-clipboard-list"></i> Registros
          </li>
          <li [class.active]="activeConfigTab === 'theme'" (click)="activeConfigTab = 'theme'">
            <i class="fas fa-palette"></i> Tema
          </li>
          <li [class.active]="activeConfigTab === 'access'" (click)="activeConfigTab = 'access'">
            <i class="fas fa-shield-alt"></i> Acceso
          </li>
          <li [class.active]="activeConfigTab === 'updates'" (click)="activeConfigTab = 'updates'">
            <i class="fas fa-sync"></i> Actualizaciones
          </li>
          <li [class.active]="activeConfigTab === 'info'" (click)="activeConfigTab = 'info'">
            <i class="fas fa-info-circle"></i> Información
          </li>
        </ul>
      </aside>

      <main class="config-content">
        <!-- Sección Registros -->
        <div *ngIf="activeConfigTab === 'logs'" class="config-section">
          <h3>Registros de Eventos</h3>
          <label class="toggle-row">
            <span>Activar registro de eventos</span>
            <input type="checkbox" [(ngModel)]="config.logs.enabled">
          </label>
          <label class="toggle-row">
            <span>Reportar al Creador (Log, Red)</span>
            <input type="checkbox" [(ngModel)]="config.logs.reportToCreator">
          </label>
        </div>

        <!-- Sección Tema -->
        <div *ngIf="activeConfigTab === 'theme'" class="config-section">
          <h3>Apariencia</h3>
          <div class="theme-selector">
            <div class="theme-option" [class.selected]="config.theme === 'light'" (click)="config.theme = 'light'">Claro</div>
            <div class="theme-option" [class.selected]="config.theme === 'dark'" (click)="config.theme = 'dark'">Oscuro</div>
            <div class="theme-option" [class.selected]="config.theme === 'sandra'" (click)="config.theme = 'sandra'">Sandra Teal Soft</div>
          </div>
        </div>

        <!-- Sección Acceso -->
        <div *ngIf="activeConfigTab === 'access'" class="config-section">
          <h3>Control de Acceso</h3>
          <label class="toggle-row">
            <span>Activar control de acceso remoto</span>
            <input type="checkbox" [(ngModel)]="config.access.remoteControl">
          </label>
          <label class="toggle-row">
            <span>Emisión de mensajes en la red</span>
            <input type="checkbox" [(ngModel)]="config.access.networkBroadcast">
          </label>
        </div>

        <!-- Sección Actualizaciones -->
        <div *ngIf="activeConfigTab === 'updates'" class="config-section">
          <h3>Sistema</h3>
          <label class="toggle-row">
            <span>Actualizaciones automáticas</span>
            <input type="checkbox" [(ngModel)]="config.updates.autoUpdate">
          </label>
        </div>

        <!-- Sección Información -->
        <div *ngIf="activeConfigTab === 'info'" class="config-section info-section">
          <h3>Sandra Desktop Container</h3>
          <p class="version-text">Versión 1.0.0 Alpha</p>
          <p class="desc-text">Plataforma de orquestación segura para aplicaciones de escritorio distribuidas.</p>
          
          <div class="help-box">
            <h4><i class="fas fa-book"></i> Referencias de Seguridad</h4>
            <ul>
              <li>Conexión: <strong>WSS (WebSocket Secure)</strong></li>
              <li>Encriptación: <strong>AES-256</strong></li>
              <li>Base de Datos: <strong>SQLite Cipher</strong></li>
            </ul>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-modal-cancel" (click)="showControlPanel = false">Cancelar</button>
          <button class="btn-modal-acept" (click)="saveConfig()">Aceptar Cambios</button>
        </div>
      </main>
    </div>
  </div>
</div>